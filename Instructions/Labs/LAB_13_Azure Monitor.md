---
lab:
    title: '13 - Azure Monitor'
    module: '모듈 04 – 보안 작업 관리'
---

# 랩 13: Azure Monitor
# 학생 랩 매뉴얼

## 랩 시나리오

가상 머신 성능을 모니터링하는 개념 증명을 만들어야 합니다. 특히 다음을 수행해야 합니다.

- 원격 분석 및 로그를 수집할 수 있도록 가상 머신을 구성합니다.
- 수집할 수 있는 원격 분석 및 로그를 보여줍니다.
- 데이터를 사용하고 쿼리하는 방법을 보여줍니다. 

> 이 랩의 모든 리소스에 대해, **미국 동부** 지역을 사용하고 있습니다. 강사에게 이 영역이 수업에 사용할 영역인지 확인합니다. 

## 랩 목표

이 랩에서는 다음의 연습을 완료합니다:

- 연습 1: Azure Monitor를 사용하여 Azure 가상 머신에서 데이터 수집

### 연습 1: Azure Monitor를 사용하여 Azure 가상 머신에서 데이터 수집

### 연습 시간: 20분

이 연습에서는 다음 작업을 수행합니다. 

- 작업 1: Azure 가상 머신 배포 
- 작업 2: Log Analytics 작업 영역 만들기
- 작업 3: Log Analytics 가상 머신 확장을 사용하도록 설정
- 작업 4: 가상 머신 이벤트 및 성능 데이터 수집
- 작업 5: 수집된 데이터 보기 및 쿼리 

#### 작업 1: Azure 가상 머신 배포

1. Azure Portal **`https://portal.azure.com/`** 에 로그인합니다.

    >**참고**: 이 랩에 사용 중인 Azure 구독에 Owner 또는 Contributor 역할이 있는 계정을 사용하여 Azure Portal에 로그인합니다.

1. Azure Portal 오른쪽 상단에 있는 첫 번째 아이콘을 클릭하여 Cloud Shell을 엽니다. 메시지가 표시되면 **PowerShell**을 선택하고 **스토리지를 만듭니다**.

1. Cloud Shell 창의 왼쪽 위 모서리에 있는 드롭다운 메뉴에서 **PowerShell**이 선택되었는지 확인합니다.

1. Cloud Shell 창 내의 PowerShell 세션에서 다음을 실행하여 이 랩에서 사용할 리소스 그룹을 만듭니다.
  
    ```powershell
    New-AzResourceGroup -Name AZ500LAB131415 -Location 'EastUS'
    ```

    >**참고**: 이 리소스 그룹은 랩 13, 14 및 15에 사용됩니다. 

1. Cloud Shell 창 내의 PowerShell 세션에서 다음을 실행하여 새 Azure 가상 머신을 만듭니다. 

    ```powershell
    New-AzVm -ResourceGroupName "AZ500LAB131415" -Name "myVM" -Location 'EastUS' -VirtualNetworkName "myVnet" -SubnetName "mySubnet" -SecurityGroupName   "myNetworkSecurityGroup" -PublicIpAddressName "myPublicIpAddress" -OpenPorts 80,3389
    ```

1.  자격 증명에 대한 메시지가 표시되면:

    |설정|값|
    |---|---|
    |사용자 이름| **localadmin** |
    |암호| **Pa55w.rd1234** |

    >**참고**: 배포가 완료될 때까지 기다립니다. 

1. Cloud Shell 창 내의 PowerShell 세션에서 다음을 실행하여 **myVM**이라는 가상 머신이 생성되고 해당 **ProvisioningState**가 **성공**인지 확인합니다.

    ```powershell
    Get-AzVM -Name 'myVM' -ResourceGroupName 'AZ500LAB131415' | Format-Table
    ```

1. Cloud Shell 창을 닫습니다. 

#### 작업 2: Log Analytics 작업 영역 만들기

이 작업에서는 Log Analytics 작업 영역을 만듭니다. 

1. Azure Portal에서 Azure Portal 페이지 상단의 **검색 리소스, 서비스 및 문서** 텍스트 상자에서 **Log Analytics 작업 영역**을 입력하고 **Enter** 키를 누릅니다.

1. **Log Analytics 작업 영역** 블레이드에서 **+ 추가**를 클릭합니다.

1. **Log Analytics 작업 영역 만들기** 블레이드의  **기본** 탭에서 다음 설정을 지정합니다(다른 설정을 기본값으로 남겨둡니다).

    |설정|값|
    |---|---|
    |구독|이 랩에서 사용 중인 Azure 구독의 이름|
    |리소스 그룹| **AZ500LAB131415** |
    |이름|유효하고 전역적으로 고유한 이름|
    |지역| **(미국) 미국 동부** |

1. **다음:** **Log Analytics 작업 영역 만들기** 블레이드의 **가격 책정 계층**의 **가격 책정 계층 >** 에서 기본 **종량제(GB 2018당)** 가격 책정 계층을 수락하고 **검토 +만들기**를 클릭합니다.

1. **Log Analytics 작업 영역 만들기** 블레이드의 **검토 + 만들기**탭에서 **만들기**를 클릭합니다.     

1. **검토 + 만들기**, **만들기**를 차례로 클릭합니다.

#### 작업 3: Log Analytics 가상 머신 확장을 사용하도록 설정

이 작업에서는 Log Analytics 가상 컴퓨터 확장을 활성화합니다. 이 확장은 Windows 및 Linux 가상 컴퓨터에 Log Analytics 에이전트를 설치합니다. 이 에이전트는 가상 머신에서 데이터를 수집하고 지정한 Log Analytics 작업 영역으로 전송합니다. 에이전트가 설치되면 자동으로 업그레이드되어 항상 최신 기능과 픽스가 적용됩니다. 

1. Azure Portal에서 **Log Analytics 작업 영역** 블레이드로 다시 이동한 다음 작업 영역 목록에서 이전 작업에서 만든 작업 영역을 나타내는 항목을 클릭합니다.

1. **작업 영역 데이터 원본** 섹션에서 Log Analytics 작업 영역 블레이드에서 **가상 컴퓨터** 항목을 클릭합니다.

    >**참고**: 에이전트를 성공적으로 설치하려면 가상 머신이 실행되어야 합니다.

1. 가상 컴퓨터 목록에서 이 연습의 첫 번째 작업에 배포한 Azure VM **myVM**을 나타내는 항목을 찾습니다. 이것은 **연결되지 않음**으로 나열되어 있습니다.

1. **myVM** 항목을 클릭한 다음 **myVM** 블레이드에서 **연결**을 클릭합니다. 

1. 가상 머신이 Log Analytics 작업 영역에 연결될 때까지 기다립니다.

    >**참고**: 몇 분 정도 걸릴 수 있습니다. **myVM** 블레이드에 표시되는 **상태**는 **연결**에서 **이 작업 영역**으로 변경됩니다. 

#### 작업 4: 가상 머신 이벤트 및 성능 데이터 수집

이 작업에서는 Windows 시스템 로그 및 여러 일반적인 성능 카운터의 컬렉션을 구성합니다. 사용 가능한 다른 원본도 검토합니다.

1. Azure Portal에서 이 연습에서 이전에 만든 Log Analytics 작업 영역으로 다시 이동합니다.

1. Log Analytics 작업 영역 블레이드의 **설정** 섹션에서 **고급 설정**을 클릭합니다.

1. **고급 설정** 블레이드에서 **데이터**를 클릭하고 Windows 이벤트 로그, Windows 성능 카운터, Linux 성능 카운터, IIS 로그 및 Syslog를 포함한 사용 가능한 옵션을 검토합니다. 

1. **다음 이벤트 로그에서 이벤트 수집** 텍스트 상자에서 **Windows 이벤트 로그**가 선택되었는지 확인하고 **시스템**을 입력하고 **+** 를 클릭합니다.

    >**참고**: 이렇게 작업 영역에 이벤트 로그를 추가합니다. 기타 선택 사항으로는 **하드웨어 이벤트** 또는 **키 관리 서비스** 등이 있습니다.  

1. **정보** 확인란 선택을 취소하고 **오류** 및 **경고** 확인란을 선택한 상태로 둡니다.

1. **Windows 성능 카운터**를 클릭합니다.

    >**참고**: 성능 카운터 권장 목록이 있습니다. 이 목록을 사용자 지정할 수 있습니다. 

1. **선택한 성능 카운터 추가**를 클릭합니다. 

    >**참고**: 카운터가 추가되고 수집 샘플 간격은 10초로 구성됩니다.
  
1. **고급 설정** 블레이드의 페이지 상단에서 **저장**을 클릭한 다음 확인을 승인하려면 **확인**을 클릭합니다.

#### 작업 5: 수집된 데이터 보기 및 쿼리

이 작업에서는 데이터 컬렉션에서 로그 검색을 실행합니다. 

1. Azure Portal에서 이 연습에서 이전에 만든 Log Analytics 작업 영역으로 다시 이동합니다.

1. Log Analytics 작업 영역 블레이드에 있는 **일반** 섹션에서 **로그**를 클릭합니다.

1. 로그 블레이드에서 **시작하기**를 클릭합니다.  

1. **예제 쿼리** 창에서 **가상 머신**을 클릭합니다.

1. 미리 정의된 쿼리 목록을 검토하고 테스트할 쿼리를 식별하고 해당 **실행** 단추를 클릭합니다.

    >**참고**: **가상 컴퓨터 사용 가능한 메모리** 쿼리를 시작할 수 있습니다.

1. 쿼리는 새 쿼리 탭에서 자동으로 열립니다. 

    >**참고**: Log Analytics는 Kusto 쿼리 언어를 사용합니다. 기존 쿼리를 사용자 지정하거나 직접 만들 수 있습니다. 

    >**참고**: 선택한 쿼리의 결과는 쿼리 창 아래에 자동으로 표시됩니다. 쿼리를 다시 실행하려면 **실행**을 클릭합니다.

    >**참고**: 이 가상 머신은 방금 만들어졌기 때문에 아직 데이터가 없을 수 있습니다. 

    >**참고**: 다른 형식으로 데이터를 표시하는 옵션이 있습니다. 쿼리 결과에 따라 경고 규칙을 만드는 옵션도 있습니다.

> 결과: Log Analytics 작업 영역을 사용하여 데이터 원본 및 쿼리 로그를 구성했습니다. 

**리소스 정리**

>**참고**: Azure Security Center 랩 및 Azure Sentinel 랩에 필요한 리소스를 이 랩에서 제거하지 마세요.
 
